---
layout: post
title: 使用 C++ 解析 tar 格式的文件
categories: OS
description: 使用 C++ 解析 tar 格式的文件
keywords: lz4, tar
---

公司的游戏有边玩边下载的功能，就是将一些资源文件压缩后放在服务器，客户端启动后再去拉取，然后解压使用。用的是 C# 的 lz4 进行的压缩和解压缩，导致申请的内存没办法及时释放（mono 虚拟机申请的内存是不会归还给系统的)，所以如果手机上如果经历了边玩边下载的话，峰值内存会有大概100M+的上浮，这对于一些内存比较受限的机器来说是比较受限的。


### 问题说明

1. C# mono虚拟机申请的内存是不会归还给系统的。
2. 原生语言（C/C++）可以自由控制内存的释放。
3. 如果想内存峰值降低，则需要将原来由 C# 开发的 lz4 模块，改用 C/C++ 实现，然后由 C# 调用，从而达到降低内存峰值的目的。

### 实现方案

Github 上有 C 语言实现的 lz4 可以直接用，源码在这里：

* [https://github.com/lz4/lz4](https://github.com/lz4/lz4)

参考根目录下 examples 里的例子即可实现对一个文件进行 lz4 的压缩和解压缩，里面的文档和例子都很清楚，对部分就不做赘述了。

这里有一个问题，这个 lz4 的包只能针对单个二进制文件进行压缩，无法处理文件夹。如果需要对文件夹进行压缩时，就需要先将文件夹合并成一个二进制文件，解压后再分割还原成文件夹。

在 Linux 中将文件夹合并成单个文件通常使用 tar 命令，在 iOS 平台尝试了下，是无法调用 Shell 命令的，所以需要自己去实现一下。

### Tar 格式
